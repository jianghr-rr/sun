## 《毛泽东大传》联动地图：执行计划

本文档追踪实施进度，每一步完成后打勾，再开始下一步。

---

### 整体步骤概览

| 步骤 | 名称 | 状态 | 说明 |
|------|------|------|------|
| 1 | 需求确认 | ✅ 已完成 | 确认节点粒度、路线来源、区域类型、时间轴要求 |
| 2 | 数据结构准备 | ✅ 已完成 | 创建目录结构、定义 TypeScript 类型 |
| 3 | MVP 范围选定 | ✅ 已完成 | 第一卷"横空出世"作为 MVP |
| 4 | 数据导入与标注 | ✅ 已完成 | 从 DOCX 提取文本、标注地点、创建节点数据 |
| 5 | 阅读器 UI | ✅ 已完成 | 目录组件 + 正文阅读区 + 布局 |
| 6 | 地图场景切换 | ✅ 已完成 | Node 切换时地图要素/镜头联动 |
| 7 | 路线动画 | ✅ 已完成 | 迁移路线的绘制/游标动画 |
| 8 | 双向联动 | ✅ 已完成 | 文案↔地图互相定位与高亮 |

---

## 步骤 1：需求确认 ✅

### 目标
确认关键设计决策，避免后续返工。

### 最终决策

| 项目 | 决策 | 说明 |
|------|------|------|
| **1.1 节点粒度** | A. 段落级 | 约 500-1500 字/节点，每个明确"时期/场景/地点变化"作为一个节点 |
| **1.2 路线来源** | C. 混合 | MVP 先用高德 API，重要迁移后续手工修订 |
| **1.3 区域类型** | A. 行政区 | MVP 先用行政区范围，后续重要场景再手工圈定 |
| **1.4 时间轴** | B. 先做节点切换 | MVP 聚焦"选择节点 → 联动"，时间轴作为后续增强 |
| **1.5 MVP 选卷** | 第一卷 | "横空出世"，韶山冲→长沙，地点变化明确 |

### 状态
✅ **已完成**（2026-01-16）

---

## 步骤 2：数据结构准备 ✅

### 目标
创建数据目录、定义 TypeScript 类型、准备空壳示例数据，为后续数据导入打好基础。

### TODO 清单

- [x] **2.1** 创建数据目录结构
- [x] **2.2** 定义 TypeScript 类型（`apps/sun/types/narrative.ts`）
- [x] **2.3** 创建作品索引（`data/mao-dazhuan/index.json`）
- [x] **2.4** 创建地点库（`data/mao-dazhuan/geo/places.json`）
- [x] **2.5** 创建示例节点数据（`nodes/v01/c00.json` + `c01.json`）

### 已创建文件

```
apps/sun/
├── types/
│   └── narrative.ts              # TypeScript 类型定义（Work/Volume/Chapter/Node/Place/Route 等）
└── data/
    └── mao-dazhuan/
        ├── index.json            # 作品索引（第一卷，引子+第1章）
        ├── nodes/
        │   └── v01/
        │       ├── c00.json      # 引子节点（1个：沁园春·长沙）
        │       └── c01.json      # 第1章节点（5个：韶山地理→毛氏家族）
        ├── content/
        │   └── v01/              # （待后续填充 Markdown 切片）
        └── geo/
            ├── places.json       # 地点库（7个：韶山冲、韶峰、湘潭、长沙等）
            ├── regions/          # （待后续添加行政区 GeoJSON）
            └── routes/           # （待后续添加路线缓存）
```

### 数据统计
- 节点：6 个（引子 1 + 第 1 章 5）
- 地点：7 个（韶山冲、韶峰、湘潭、长沙、唐家圫、湘乡、橘子洲）
- 区域：0 个（待添加）
- 路线：0 条（待添加）

### 状态
✅ **已完成**（2026-01-16）

---

## 步骤 4：数据导入与标注 ✅

### 目标
根据第一卷第一章完整内容，切分节点、补充地点库、生成 Markdown 正文切片。

### 内容分析（第一卷 引子+第1章）

**引子（2 个节点）：**
| ID | 标题 | 主要地点 | 说明 |
|----|------|----------|------|
| V01-C00-P0001 | 沁园春·长沙 | 橘子洲、长沙 | 词作 + 革命形势背景 |
| V01-C00-P0002 | 作者生平概述 | 无特定地点 | 戎马22年、治国27年 + 读者导言 |

**第1章（14 个节点）：**
| ID | 标题 | 主要地点 | 时间 |
|----|------|----------|------|
| V01-C01-P0001 | 韶山地理 | 韶峰 | - |
| V01-C01-P0002 | 韶山冲概貌 | 韶山冲、湘潭、长沙 | - |
| V01-C01-P0003 | 韶山冲农民生活 | 韶山冲、上屋场 | - |
| V01-C01-P0004 | 毛氏起源：毛太华从军 | 江西吉水→云南澜沧 | 14世纪中叶 |
| V01-C01-P0005 | 毛氏定居韶山 | 湘乡→韶山 | 1380年 |
| V01-C01-P0006 | 毛氏族谱与家训 | 韶山 | 1737年、1881年 |
| V01-C01-P0007 | 祖父辈：毛祖人与毛翼臣 | 韶山冲、上屋场 | 1823-1904 |
| V01-C01-P0008 | 父亲毛顺生与文家 | 韶山冲、唐家圫 | 1870-1880s |
| V01-C01-P0009 | 母亲文七妹 | 唐家圫→韶山冲 | 1867- |
| V01-C01-P0010 | 毛顺生治家与毛泽东出生 | 韶山冲、银田寺 | 1893.12.26 |
| V01-C01-P0011 | 毛泽东童年在外婆家 | 唐家圫、龙潭坳 | 1893-1902 |
| V01-C01-P0012 | 入私塾与顽童故事 | 南岸私塾 | 1902- |
| V01-C01-P0013 | 与塾师冲突、罢课逃跑 | 南岸私塾、韶山冲 | 1903 |
| V01-C01-P0014 | 与父亲冲突、智斗赵某 | 韶山冲、石砚冲 | - |

### TODO 清单

- [x] **4.1** 补充地点库（新增 11 个地点）
- [x] **4.2** 更新引子节点数据（`c00.json`）
- [x] **4.3** 更新第1章节点数据（`c01.json`）
- [x] **4.4** 更新作品索引（`index.json`）
- [ ] **4.5** 创建 Markdown 正文切片（可选，后续做）

### 最终数据统计
- **地点库**：18 个地点
  - 韶山冲、上屋场、韶峰、湘潭、长沙、唐家圫、湘乡、宁乡、橘子洲
  - 江西吉水、云南澜沧、绯紫桥、东茅塘、银田寺、龙潭坳、南岸私塾、凤凰山、石砚冲
- **节点数**：16 个（引子 2 + 第 1 章 14）
- **路线引用**：5 条（毛太华从军、毛氏定居、祖父搬家、文七妹出嫁、智斗赵某路上）
- **正文**：完整覆盖第一卷引子 + 第 1 章全部内容

### 状态
✅ **已完成**（2026-01-16）

---

## 步骤 5：阅读器 UI ✅

### 目标
创建阅读器页面布局、目录组件、正文阅读区，实现节点切换与数据加载。

### TODO 清单

- [x] **5.1** 创建数据加载工具（`lib/narrative.ts`）
- [x] **5.2** 创建状态管理（`hooks/useNarrative.ts`）
- [x] **5.3** 创建目录组件（`components/TableOfContents.tsx`）
- [x] **5.4** 创建正文阅读区（`components/ContentReader.tsx`）
- [x] **5.5** 创建阅读器布局（`components/ReaderLayout.tsx`）
- [x] **5.6** 更新首页（`app/page.tsx`）

### 已创建文件

```
apps/sun/
├── lib/
│   └── narrative.ts              # 数据加载工具（索引、节点、地点）
├── hooks/
│   └── useNarrative.ts           # 状态管理 Hook（节点选择、URL 同步）
├── components/
│   ├── TableOfContents.tsx       # 目录组件（卷/章/节点树）
│   ├── ContentReader.tsx         # 正文阅读区（标题、时间、正文、导航）
│   ├── ReaderLayout.tsx          # 阅读器布局（目录+正文+地图）
│   └── ReaderPage.tsx            # 阅读器页面（集成所有组件）
├── app/
│   └── page.tsx                  # 首页（使用 ReaderPage）
└── public/
    └── data/mao-dazhuan/         # 数据文件（供 fetch 加载）
        ├── index.json
        ├── nodes/v01/c00.json
        ├── nodes/v01/c01.json
        └── geo/places.json
```

### 功能实现
- ✅ 目录树：卷/章/节点可折叠，当前节点高亮
- ✅ 正文阅读：显示标题、时间、地点、正文、来源
- ✅ 节点导航：上一节/下一节按钮
- ✅ URL 同步：`?node=V01-C01-P0001` 可分享、可刷新恢复
- ✅ 响应式布局：桌面端侧边栏固定，移动端抽屉
- ✅ 地图底层：保持现有 Cesium 地图

### 状态
✅ **已完成**（2026-01-16）

---

## 步骤 6：地图场景切换 ✅

### 目标
当节点切换时，地图自动联动：显示对应地点标记、镜头飞到指定位置。

### TODO 清单

- [x] **6.1** 创建地图场景管理 Hook（`hooks/useMapScene.ts`）
- [x] **6.2** 更新 MapViewer 组件
- [x] **6.3** 集成到 ReaderLayout
- [x] **6.4** 地点标记样式

### 已修改/创建文件

```
apps/sun/
├── hooks/
│   └── useMapScene.ts            # 地图场景管理（计算标记、镜头）
├── components/
│   ├── MapViewer.tsx             # 重构：接收场景配置，动态更新标记和镜头
│   ├── DynamicMapViewer.tsx      # 更新：添加 scene 参数类型
│   ├── ReaderLayout.tsx          # 集成 useMapScene，传递场景给地图
│   └── ReaderPage.tsx            # 简化：不再需要传递 children
```

### 功能实现
- ✅ 节点切换时地图自动飞到对应位置（flyTo 动画）
- ✅ 地图上显示当前节点的地点标记（Entity）
- ✅ 标记样式区分主次：
  - **primary**：红色大图标 + 黄色标签 + 背景
  - **context**：蓝色小图标 + 灰白色标签
- ✅ 支持两种镜头模式：
  - **preset**：预设经纬度、高度、角度
  - **autoFit**：根据所有标记点自动计算边界
- ✅ 切换节点时自动清理旧标记

### 状态
✅ **已完成**（2026-01-16）

---

## 步骤 7：路线动画 ✅

### 目标
当节点包含路线（迁移）信息时，在地图上绘制路线并展示动画效果。

### TODO 清单

- [x] **7.1** 扩展 useMapScene Hook（已有 route 字段）
- [x] **7.2** 创建路线获取逻辑（`hooks/useRoute.ts`）
- [x] **7.3** 更新 MapViewer 绘制路线
- [x] **7.4** 路线样式（发光线条 + 起终点标记）

### 已修改/创建文件

```
apps/sun/
├── hooks/
│   └── useRoute.ts               # 路线获取 Hook（高德 API + 缓存）
├── components/
│   ├── MapViewer.tsx             # 新增路线绘制功能
│   ├── DynamicMapViewer.tsx      # 添加 routeData 参数
│   └── ReaderLayout.tsx          # 集成 useRoute，传递路线数据
```

### 功能实现
- ✅ 节点有迁移时自动调用高德 API 获取路线
- ✅ 路线数据缓存（避免重复请求）
- ✅ 青色发光线条（`PolylineGlowMaterialProperty`）
- ✅ 起点标记：绿色 + "起：地名"
- ✅ 终点标记：橙色 + "终：地名"
- ✅ 切换节点时自动清理旧路线
- ✅ 路线加载指示器

### 有路线的节点示例
- V01-C01-P0004：毛太华从军（江西吉水 → 云南澜沧）
- V01-C01-P0005：毛氏定居（云南澜沧 → 韶山东茅塘）
- V01-C01-P0009：文七妹出嫁（唐家圫 → 上屋场）

### 状态
✅ **已完成**（2026-01-16）

---

## 步骤 8：双向联动 ✅

### 目标
实现文本与地图的双向互动：
- 正文中的地名可点击，点击后地图高亮该地点
- 地图上的标记可点击/悬停，同步高亮状态

### TODO 清单

- [x] **8.1** 正文地名高亮与点击
- [x] **8.2** 地图标记点击/悬停交互
- [x] **8.3** 联动状态管理

### 已修改文件

```
apps/sun/components/
├── ContentReader.tsx       # 地名标签可点击/悬停，触发高亮
├── MapViewer.tsx           # 标记点击/悬停事件，高亮样式
├── DynamicMapViewer.tsx    # 添加交互回调参数
└── ReaderLayout.tsx        # 管理高亮状态，连接双向联动
```

### 功能实现
- ✅ **正文 → 地图**：
  - 头部地名标签可点击，点击后地图飞到该位置并高亮
  - 悬停地名标签，地图标记临时高亮
  - 高亮样式：亮黄色大图标 + 白色标签 + 黄色背景
- ✅ **地图 → 正文**：
  - 标记可点击/悬停，触发高亮状态同步
  - 鼠标悬停标记时显示手型光标
- ✅ **高亮状态管理**：
  - 点击后高亮 3 秒自动消失
  - 悬停时实时同步高亮

### 状态
✅ **已完成**（2026-01-16）

---

## 变更记录

| 日期 | 变更内容 |
|------|----------|
| 2026-01-16 | 创建执行计划文档，列出步骤 1 TODO |
| 2026-01-16 | 步骤 1 完成，用户确认所有决策；展开步骤 2 详细 TODO |
| 2026-01-16 | 步骤 2 完成，创建数据目录、类型定义、示例数据（6 节点 + 7 地点） |
| 2026-01-16 | 步骤 4 完成，导入第一卷引子+第1章完整内容（16 节点 + 18 地点 + 5 路线引用） |
| 2026-01-16 | 步骤 5 完成，创建阅读器 UI（目录+正文+布局+URL 同步） |
| 2026-01-16 | 步骤 6 完成，地图场景切换（标记+镜头联动） |
| 2026-01-16 | 步骤 7 完成，路线绘制（高德 API + 发光线条 + 起终点标记） |
| 2026-01-16 | 步骤 8 完成，双向联动（正文↔地图高亮同步） |


