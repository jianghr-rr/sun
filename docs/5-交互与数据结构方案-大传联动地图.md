## 《毛泽东大传》联动地图：交互与数据结构方案（规划稿）

目标：把“**一段文本（叙事）**—**同一时期的地点/区域**—**地点变化的迁移路线**—**文本展示与定位**”做成统一的可维护系统，并满足：
- **尽量减少路由切换**：核心交互在单页完成（只用 URL 参数做可分享的状态同步）。
- **地图切换动态**：地点/区域/路线/镜头切换均有平滑动画与过渡。

---

### 一、核心体验（用户视角）

用户在同一个页面里完成三件事：
- **读**：阅读某个“时期/事件段落”的正文（可长文，支持锚点与目录）。
- **看**：地图上出现该时期的**地点点位** / **活动区域**。
- **跟随**：当文本中出现**地点变化**时，地图展示**迁移路线**（含动画），并可回放/逐段跳转。

双向联动：
- **点文案** → 地图聚焦、元素高亮、路线播放到对应段。
- **点地图元素** → 文案滚动到对应段落并高亮。

---

### 二、页面结构（最少路由切换）

推荐**单路由单页**（例如仍在 `/` 或新增 `/reader`，但不做多层跳转）：
- 左侧（或移动端抽屉）：**目录/选择器**
  - 卷（Volume）→ 章（Chapter）→ 段（Passage/Scene）
- 右侧：**正文阅读区**
  - 当前段落正文
  - 段内小目录/锚点（可按小标题或“地点切换点”自动生成）
- 背景/下层：**全屏地图**
  - 当前段落的点/面/线要素叠加
  - 动态镜头（flyTo / fitBounds）

路由策略：
- **不切页面路由**，只用 `searchParams` 同步关键状态，便于分享与刷新恢复：
  - `?work=mao-dazhuan&node=V01-C01-P0003`
  - 可选：`&t=...`（时间游标）、`&layer=route`（显隐层）

---

### 二点五、文本显示（阅读体验与可维护性）

核心原则：**读起来像“电子书”**，同时能承载“地图联动锚点 / 引用来源 / 分享定位”。

#### 2.5.1 阅读区布局（桌面 / 移动端）
- 桌面：
  - 阅读列建议控制行宽（例如 `max-w-prose`），提升可读性
  - 目录树（卷/章/段）可折叠，阅读区保持稳定不抖动
  - 地图全屏在底层，阅读区用半透明/卡片化浮层，避免遮挡地图关键信息
- 移动端：
  - 默认“阅读优先”，地图以可展开面板/迷你地图形式存在
  - 目录树放入抽屉（Drawer），保证不切路由也能快速跳转

#### 2.5.2 文本格式与渲染（Markdown 为主）
- 正文推荐落地为 **Markdown 切片**（按卷/章/段或按锚点切片）
- MVP 渲染能力：
  - 标题层级（h1-h4）
  - 段落、列表、引用块、粗斜体
  - 脚注/引用（先用简单约定，后续再标准化）
- 需要组件化时再升级到 **MDX**（例如文内嵌“地点卡片/引用卡片/路线按钮”）

#### 2.5.3 段内锚点（用于地图联动与分享）
每个 Node 的正文内部要有“稳定锚点”，用于：
- 文案滚动 → 地图播放到对应路线分段
- 地图点击 → 文案滚动定位到“首次提及/迁移描述”
- 复制链接分享：`?node=...&anchor=...`

锚点来源建议（两种都可）：
- **自动锚点**：按小标题生成（省人工）
- **显式锚点**：在 Markdown 中插入自定义标记（更准确，适合“地点变化点”）

#### 2.5.4 长文性能（多卷多章必须做）
- **按需加载**：
  - 首屏只加载目录索引
  - 进入某章才加载该章 Node 元信息与正文切片
- **渲染性能**：
  - 章内节点多时，目录列表用虚拟滚动（Virtual List）
  - 正文过长时，优先“切片 + 分段渲染”，避免一次性把整卷塞进 DOM

#### 2.5.5 阅读辅助能力（建议逐步加）
- 搜索：先做章内搜索（MVP），后续再做全书索引
- 高亮：
  - 当前 Node 高亮
  - 当前锚点高亮（与地图选中状态一致）
- 复制与分享：
  - 一键复制当前段落链接（含 `node`/`anchor`）
  - 选中文本复制时可附带引用信息（后续增强）

#### 2.5.6 引用与来源（合规与可信度）
- Node 级别 `sources` 用于“本段引用来源”（你在数据里已预留）
- 需要更细粒度时，再做“段内脚注”：
  - MVP 用 Markdown 脚注或简单编号约定
  - 后续可演进为结构化引用（如 CSL-JSON），但不阻塞 MVP

---

### 三、交互流程（状态机视角）

把一次“阅读/切换”抽象成：**选择叙事节点（Narrative Node）** → **地图呈现（Map Scene）** → **过渡（Transition）**。

#### 3.1 选择卷/章/段（主要入口）
- 用户在目录中选中一个段落（Node）
- 系统执行：
  - 文案区加载并滚动到段落顶部
  - 地图执行 “切场景”：
    - 清理上一个段落的高亮/路线播放状态（非立即消失，做淡出）
    - 新段落点/面/线淡入
    - 镜头 `flyTo` 到该段落建议视角（或自动 fit）

#### 3.2 文案滚动驱动地图（可选增强）
- 文案区滚动到某个锚点（例如“地点A → 地点B”）
- 地图播放到对应路线分段，并将当前位置高亮

#### 3.3 地图驱动文案（点要素/线要素/面要素）
- 点击点位：滚动到首次提及该点的锚点
- 点击路线段：滚动到对应“迁移”描述的段落
- 点击区域：展示区域注释/来源，并跳转到该区域关联段落

---

### 四、数据建模（关键：把“文本、地点、路线、镜头”绑在同一个节点上）

核心思想：以“**叙事节点 Node**”为中心，Node 引用地图要素（点/面/线）与镜头建议；地图侧则把所有要素统一成类 GeoJSON 的结构，便于渲染与后期替换来源。

#### 4.1 术语
- **Work**：作品（例如《毛泽东大传》）
- **Volume**：卷
- **Chapter**：章
- **Node / Passage / Scene**：最小联动单元（建议粒度：一段可读的叙事 + 明确的地点/路线信息）
- **Feature**：地图要素（Point/Polygon/LineString）
- **Transition**：场景切换动画策略（淡入淡出、镜头飞行、路线绘制等）

#### 4.2 数据分层（建议目录）
- `data/works/`：作品与目录索引（轻量、首屏就能加载）
- `data/nodes/`：节点内容（按卷/章拆分，按需懒加载）
- `data/geo/`：地点/区域/路线（可复用、可缓存）

示例结构（建议）：
```
apps/sun/data/
  mao-dazhuan/
    index.json                # 作品索引（卷章目录、节点 id 列表）
    nodes/
      v01/
        c01.json              # 本章所有节点（文本引用 + geo 引用 + 镜头）
    geo/
      places.json             # 标准地点库（点）
      regions/
        hunan-shaoshan.geojson
      routes-cache/
        V01-C01-P0003.json    # 可选：路线点缓存（来自高德/手工修订）
```

#### 4.3 Node（叙事节点）结构
建议 Node 具备：文本、时间范围（可空）、地图要素引用、镜头/过渡。

示例（JSON 形态，规划用）：
```json
{
  "id": "V01-C01-P0003",
  "workId": "mao-dazhuan",
  "volume": 1,
  "chapter": 1,
  "title": "韶山冲与家族渊源（节选）",
  "time": { "start": "1880-01-01", "end": "1895-12-31", "precision": "year" },
  "content": {
    "format": "md",
    "ref": "mao-dazhuan/v01/c01#P0003"
  },
  "map": {
    "features": [
      { "type": "place", "placeId": "shaoshan-chong", "label": "韶山冲", "role": "primary" },
      { "type": "region", "regionId": "hunan-shaoshan-area", "role": "context" }
    ],
    "route": null,
    "camera": { "mode": "autoFit", "padding": 0.25, "durationMs": 1200 }
  },
  "transitions": {
    "enter": { "fadeMs": 300, "flyToMs": 1200 },
    "exit": { "fadeMs": 200 }
  },
  "links": {
    "prev": "V01-C01-P0002",
    "next": "V01-C01-P0004"
  },
  "sources": [
    { "type": "book", "title": "毛泽东大传 第一卷", "loc": "第1章-节选" }
  ]
}
```

关键字段说明：
- `content.ref`：正文不直接塞进 JSON（太大），而是引用外部文本（Markdown/MDX/纯文本切片）。
- `map.features`：Node 关联的点/面要素（可多对多）。
- `map.route`：当出现迁移时，才存在路线（见 4.6）。
- `camera`：既可 `autoFit`（根据要素算范围），也可 `preset`（手工给定经纬高与朝向，效果更稳定）。

#### 4.4 Place（地点点位）结构
地点库是全局可复用资产，Node 只引用 `placeId`。

```json
{
  "id": "shaoshan-chong",
  "name": "韶山冲",
  "aliases": ["韶山"],
  "coord": { "lng": 112.53, "lat": 27.91 },
  "level": "village",
  "notes": "历史地名可能存在范围误差",
  "source": { "type": "manual", "by": "editor", "date": "2026-01-16" }
}
```

#### 4.5 Region（区域）结构
区域建议用 GeoJSON 单文件，便于直接交给 Cesium `GeoJsonDataSource`：
- `Feature.properties.id`：作为 `regionId`
- 统一样式在渲染层配置（填充透明度、描边等）

#### 4.6 Route（迁移路线）结构（两条路：手工 vs API）

路线有两类来源：
- **A. 手工/史实路线**：你已经知道迁移路径（例如长征路线），用手工坐标更可信。
- **B. 地图服务补全**：只知道起点终点（例如在某时期从 A 到 B 的移动），可用高德“驾车/步行” API 生成近似路线，并缓存下来供后续修订。

Route 建议结构：
```json
{
  "id": "route-V01-C01-P0005",
  "type": "LineString",
  "from": "shaoshan-chong",
  "to": "changsha",
  "mode": "driving",
  "points": [[112.53, 27.91], [112.98, 28.19]],
  "meta": { "distanceM": 92000, "durationS": 5400 },
  "source": { "type": "amap", "cachedAt": "2026-01-16" }
}
```

Node 引用路线时，不要直接内嵌大量点，优先用 `routeId` + 懒加载点集。

---

### 五、地图呈现与动效（“动态切换”的落点）

把地图层分成 3 类要素（与需求 2/3 对齐）：
- **点（Point）**：人物活动地点
- **面（Polygon/Rectangle）**：活动区域/势力范围/行政区（“在地图上标注区域”）
- **线（LineString）**：迁移路线（“地点变化展示路线”）

#### 5.1 场景切换（Node 切换时）
建议统一走一个 `applyScene(nextNode)` 流程（概念）：
- **退出动画**：上一个 Node 的要素做 `fadeOut`（200~300ms），避免硬切
- **进入动画**：
  - 新要素 `fadeIn`
  - 镜头 `flyTo`（800~1600ms），支持可配置缓动（easeInOut）
  - 若存在路线：先展示起终点，再逐步绘制路线（见 5.2）

#### 5.2 路线动画（迁移呈现）
推荐 2 种动画模式（可配置）：
- **绘制动画**：线条从 0% → 100% 显示（更直观）
- **游标动画**：在线上有一个“当前位置点”沿线移动，配合尾迹（更有“迁移”感）

对长路线（点数多）要做性能保护：
- 视距很远时用抽稀后的点集（降低采样）
- 拉近后再切到高精度点集（LOD）

#### 5.3 镜头策略（Camera）
推荐 3 种 camera 模式并允许 Node 覆盖：
- `autoFit`：根据当前 Node 的所有 features 计算范围并飞到合适高度（最省维护）
- `preset`：人工指定经纬度、高度、heading/pitch/roll（最稳定、最电影化）
- `followRoute`：路线播放时镜头跟随游标（可选增强，注意眩晕与晃动）

---

### 六、多卷多章的内容组织（你截图里很多卷，必须可扩展）

#### 6.1 节点粒度建议
不建议“一章一个 Node”，因为章节可能过长、地点变化太多。
建议：
- 一个 Node 对应“**一个明确时期/场景**”（例如“韶山冲介绍”、“到长沙求学”、“某次会议”）
- Node 内部再按小锚点切分（地点出现/迁移发生处），用于滚动联动与路线分段

#### 6.2 按需加载（性能）
目录索引 `index.json` 首屏加载即可；正文与路线点集都懒加载：
- 选择卷/章时才加载该章 `c01.json`
- 滚动到某段时才加载对应 markdown 切片（或一次加载章内文本但做虚拟滚动）

#### 6.3 文案存储格式（推荐顺序）
- **优先：Markdown 切片**（易读、易编辑、易加引用）
- 需要组件化时：MDX（可嵌入“地点卡片/引用卡片”组件）
- 纯文本也可，但后续标注与引用会更麻烦

---

### 七、从 DOCX/ZIP 导入到系统数据（不写代码，但把流程定下来）

你当前素材是多份 `.docx`（以及一个 zip），建议采用“**离线导入 → 生成标准化数据 → 前端只读**”：

#### 7.1 导入产物（最终进入仓库的数据）
- `index.json`：卷章目录与节点索引
- `nodes/vXX/cYY.json`：节点元信息（不直接塞大段正文）
- `content/*.md`：正文切片（带稳定锚点）
- `geo/places.json`、`geo/regions/*.geojson`、`routes-cache/*.json`

#### 7.2 导入步骤（建议）
- DOCX → HTML/Markdown（保留标题层级：卷/章/小节）
- 自动切片：
  - 按标题切片（第X卷 / 第X章 / 小节标题）
  - 或按字数阈值切片（例如 800~1500 字/段），并允许人工合并/拆分
- 人工标注：
  - 给切片绑定地点（placeId）、区域（regionId）、迁移（route from/to）
  - 这一步决定联动质量，建议先做 MVP 覆盖关键节点

---

### 八、MVP 交付切片（建议先做“能跑通”的最小集）

先只选 1 卷或 1 章做 MVP（避免一开始就被全量文本拖垮）：
- 产出 10~30 个 Node
- 地点库 20~50 个 Place
- 区域 3~10 个 Region（湖南、长沙等）
- 路线 5~10 条（只做最关键的迁移）

验收标准（对应你提的 4 点）：
- 选中 Node → 文案展示正确
- 地图出现对应点/区域
- 出现地点变化时有路线，并且路线切换/播放是动态的
- 文案与地图可互相定位（至少“点文案定位地图”先通）

---

### 九、需要你拍板/补充的信息（用于把方案落到具体数据）

为了后续“建数据”不返工，建议你确认以下约束：
- **节点粒度**：你希望联动的最小单位是“段落级”还是“事件级”（更粗）？
- **路线来源**：迁移路线更偏“史实路线”（手工）还是“现实道路近似”（高德）？
- **区域类型**：是“行政区范围”（省/市）还是“事件活动范围”（手工圈定多边形）？
- **时间轴要求**：是否一定要有可播放的时间轴（Clock），还是先做章节/段落切换即可？


