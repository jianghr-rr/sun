# 百度监控平台接入方案

## 一、概述

### 1.1 目标

在 Next.js 16 App Router 项目中接入 **百度统计**，实现：

- 页面 PV/UV 统计
- SPA 路由跳转统计
- 自定义事件追踪
- 目标转化监测（可选）

### 1.2 技术栈

- Next.js 16 (App Router)
- React 19
- TypeScript

---

## 二、前置准备

| 步骤 | 操作 |
|------|------|
| 1. 注册账号 | 访问 [百度统计](https://tongji.baidu.com) 注册账号 |
| 2. 创建站点 | 在后台「管理 → 新增网站」填写网站域名、名称 |
| 3. 获取代码 | 在「代码管理 → 代码获取」复制统计 ID（形如 `xxxxxxxxxxxxxxxx`） |

### 2.1 多环境站点配置（推荐）

**建议在百度统计后台创建多个站点**，分别对应不同环境：

| 环境 | 站点名称示例 | 域名 | 用途 |
|------|-------------|------|------|
| 测试环境 | Sun-Test | test.example.com | QA 测试验证 |
| 生产环境 | Sun-Prod | www.example.com | 正式用户数据 |

> ⚠️ **注意**：百度统计**不支持 localhost**，本地开发环境无法创建站点。

这样可以：
- ✅ 测试环境数据不污染生产数据
- ✅ 各环境独立分析，便于定位问题
- ✅ 测试环境可以验证统计功能是否正常

### 2.2 本地开发环境方案

由于百度统计不支持 `localhost`，本地开发有以下选择：

#### 方案 1：本地不启用统计（推荐）

最简单的方式，本地环境不配置 `NEXT_PUBLIC_BAIDU_TONGJI_ID`：

```bash
# .env.development - 不设置或留空
# NEXT_PUBLIC_BAIDU_TONGJI_ID=
```

代码中会自动跳过加载，控制台会打印：`[Analytics] 未配置百度统计 ID，跳过加载`

#### 方案 2：使用测试环境 ID 调试

如果需要验证统计代码逻辑，可以临时使用测试环境的 ID：

```bash
# .env.development - 临时使用测试环境 ID
NEXT_PUBLIC_BAIDU_TONGJI_ID=测试环境统计ID
```

> 百度统计会记录数据，但域名显示为 localhost，不影响测试站点的数据分析。

#### 方案 3：使用内网穿透（可选）

如果需要完整模拟线上环境，可以使用内网穿透工具：

```bash
# 使用 ngrok 暴露本地服务
npx ngrok http 3000

# 会得到类似 https://abc123.ngrok.io 的公网地址
# 可以在百度统计创建对应站点
```

---

## 三、实现方案

### 3.1 环境变量配置

#### 方案 A：多站点 ID（推荐）

为每个环境配置独立的百度统计 ID：

```bash
# .env.development（本地开发）
NEXT_PUBLIC_BAIDU_TONGJI_ID=开发环境统计ID

# .env.test（测试环境）- 需要在部署时注入
NEXT_PUBLIC_BAIDU_TONGJI_ID=测试环境统计ID

# .env.production（生产环境）
NEXT_PUBLIC_BAIDU_TONGJI_ID=生产环境统计ID
```

#### 方案 B：仅生产环境启用

如果只想在生产环境统计，开发/测试环境不上报：

```bash
# .env.development - 留空或不设置
# NEXT_PUBLIC_BAIDU_TONGJI_ID=

# .env.production
NEXT_PUBLIC_BAIDU_TONGJI_ID=你的生产环境统计ID
```

#### 方案 C：代码层面控制

在组件中根据环境变量或域名判断：

```ts
// 判断是否为生产环境
const isProduction = process.env.NODE_ENV === 'production'

// 或根据域名判断
const isProductionDomain = typeof window !== 'undefined' 
  && window.location.hostname === 'www.example.com'
```

> ⚠️ 必须使用 `NEXT_PUBLIC_` 前缀，否则客户端无法访问。

### 3.2 创建百度统计组件

创建 `apps/sun/components/BaiduAnalytics.tsx`：

```tsx
'use client'

import { useEffect } from 'react'
import { usePathname, useSearchParams } from 'next/navigation'

// 声明全局类型
declare global {
  interface Window {
    _hmt: Array<[string, ...unknown[]]>
  }
}

const BAIDU_TONGJI_ID = process.env.NEXT_PUBLIC_BAIDU_TONGJI_ID

// 可选：仅在生产环境启用（如果使用方案 B）
// const ENABLE_ANALYTICS = process.env.NODE_ENV === 'production'

export function BaiduAnalytics() {
  const pathname = usePathname()
  const searchParams = useSearchParams()

  // 初始化百度统计脚本
  useEffect(() => {
    // 如果没有配置 ID，则不加载（适用于方案 B：测试环境不配置 ID）
    if (!BAIDU_TONGJI_ID) {
      console.log('[Analytics] 未配置百度统计 ID，跳过加载')
      return
    }

    // 可选：额外的环境判断（如果使用方案 B）
    // if (!ENABLE_ANALYTICS) {
    //   console.log('[Analytics] 非生产环境，跳过加载')
    //   return
    // }

    console.log('[Analytics] 加载百度统计，ID:', BAIDU_TONGJI_ID.slice(0, 6) + '...')

    // 初始化 _hmt 数组
    window._hmt = window._hmt || []

    // 动态插入统计脚本
    const script = document.createElement('script')
    script.src = `https://hm.baidu.com/hm.js?${BAIDU_TONGJI_ID}`
    script.async = true
    document.head.appendChild(script)

    return () => {
      // 组件卸载时移除脚本（可选）
      document.head.removeChild(script)
    }
  }, [])

  // 监听路由变化，上报 PV
  useEffect(() => {
    if (!BAIDU_TONGJI_ID) return

    const url = pathname + (searchParams?.toString() ? `?${searchParams.toString()}` : '')

    // 上报页面浏览
    window._hmt = window._hmt || []
    window._hmt.push(['_trackPageview', url])

    // 开发时可打开调试日志
    if (process.env.NODE_ENV === 'development') {
      console.log('[Analytics] PV:', url)
    }
  }, [pathname, searchParams])

  return null
}
```

### 3.3 创建事件追踪工具函数

创建 `apps/sun/lib/analytics.ts`：

```ts
/**
 * 百度统计工具函数
 */

declare global {
  interface Window {
    _hmt: Array<[string, ...unknown[]]>
  }
}

const isDev = process.env.NODE_ENV === 'development'

/**
 * 追踪自定义事件
 * @param category - 事件分类（如：'Button', 'Video', 'Form'）
 * @param action - 事件操作（如：'Click', 'Play', 'Submit'）
 * @param label - 事件标签（可选，如：按钮名称）
 * @param value - 事件值（可选，数字类型）
 */
export function trackEvent(
  category: string,
  action: string,
  label?: string,
  value?: number
) {
  if (typeof window === 'undefined' || !window._hmt) {
    if (isDev) console.log('[Analytics] trackEvent 跳过 - _hmt 未初始化')
    return
  }

  const params: [string, string, string, string?, number?] = ['_trackEvent', category, action]
  if (label) params.push(label)
  if (value !== undefined) params.push(value)

  window._hmt.push(params)

  // 开发环境打印调试日志
  if (isDev) {
    console.log('[Analytics] Event:', { category, action, label, value })
  }
}

/**
 * 手动上报页面浏览（用于特殊场景）
 * @param url - 页面路径
 */
export function trackPageview(url: string) {
  if (typeof window === 'undefined' || !window._hmt) {
    if (isDev) console.log('[Analytics] trackPageview 跳过 - _hmt 未初始化')
    return
  }

  window._hmt.push(['_trackPageview', url])

  if (isDev) {
    console.log('[Analytics] Manual PV:', url)
  }
}
```

### 3.4 集成到 Layout

修改 `apps/sun/app/layout.tsx`：

```tsx
import type { Metadata } from 'next'
import { cookies } from 'next/headers'
import { Inter } from 'next/font/google'
import { Suspense } from 'react'
import './globals.css'

import { Providers } from './providers'
import { BaiduAnalytics } from '../components/BaiduAnalytics'

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
})

export const metadata: Metadata = {
  title: 'Sun',
  description: 'A clean Next.js starter',
}

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const cookieStore = await cookies()
  const initialColorMode =
    cookieStore.get('chakra-ui-color-mode')?.value === 'dark' ? 'dark' : 'light'

  return (
    <html className={initialColorMode} lang="zh-CN" suppressHydrationWarning>
      <body className={`${inter.variable} antialiased`}>
        <Providers initialColorMode={initialColorMode}>{children}</Providers>
        {/* 百度统计 - 需要 Suspense 包裹因为使用了 useSearchParams */}
        <Suspense fallback={null}>
          <BaiduAnalytics />
        </Suspense>
      </body>
    </html>
  )
}
```

---

## 四、使用示例

### 4.1 追踪按钮点击

```tsx
'use client'

import { trackEvent } from '@/lib/analytics'

export function DownloadButton() {
  const handleClick = () => {
    trackEvent('Button', 'Click', '下载按钮')
    // 执行下载逻辑...
  }

  return <button onClick={handleClick}>下载</button>
}
```

### 4.2 追踪表单提交

```tsx
'use client'

import { trackEvent } from '@/lib/analytics'

export function ContactForm() {
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    trackEvent('Form', 'Submit', '联系我们表单')
    // 执行提交逻辑...
  }

  return (
    <form onSubmit={handleSubmit}>
      {/* 表单内容 */}
    </form>
  )
}
```

### 4.3 追踪视频播放

```tsx
'use client'

import { trackEvent } from '@/lib/analytics'

export function VideoPlayer({ videoId }: { videoId: string }) {
  const handlePlay = () => {
    trackEvent('Video', 'Play', videoId)
  }

  const handleComplete = () => {
    trackEvent('Video', 'Complete', videoId)
  }

  return (
    <video 
      onPlay={handlePlay}
      onEnded={handleComplete}
    >
      {/* 视频源 */}
    </video>
  )
}
```

---

## 五、验证测试

### 5.1 检查脚本加载

1. 打开浏览器开发者工具 → Network 面板
2. 刷新页面
3. 搜索 `hm.baidu.com`
4. 确认有请求且状态为 200

### 5.2 验证 PV 上报

1. 在控制台输入 `window._hmt`，确认数组存在
2. 切换页面路由，观察 Network 中是否有新请求
3. 登录百度统计后台，查看「实时访客」

### 5.3 验证事件上报

1. 触发自定义事件（如点击按钮）
2. 在控制台查看 `window._hmt` 数组是否新增事件记录
3. 在百度统计后台「行为分析 → 事件分析」查看

---

## 六、注意事项

### 6.1 技术注意

- **避免重复插入脚本**：BaiduAnalytics 组件已做防护，确保脚本只插入一次
- **SSR 兼容**：所有统计代码都在客户端执行，使用 `'use client'` 指令
- **Suspense 包裹**：由于使用 `useSearchParams`，需要 Suspense 边界

### 6.2 数据合规

- 根据《个人信息保护法》要求，建议在隐私政策中披露使用了百度统计
- 如需 GDPR 合规，考虑增加 Cookie 同意弹窗，仅在用户同意后加载统计脚本

### 6.3 环境区分

```ts
// 可以根据环境决定是否启用统计
const shouldTrack = process.env.NODE_ENV === 'production'

// 在 BaiduAnalytics 组件中
if (!shouldTrack || !BAIDU_TONGJI_ID) return null
```

### 6.4 内部流量过滤

在百度统计后台「管理 → 过滤规则」可设置：
- IP 过滤：排除公司内网 IP
- 来源过滤：排除特定域名（如 localhost）

---

## 七、文件结构

实施后新增/修改的文件：

```
apps/sun/
├── .env.local                    # 新增：本地环境变量
├── .env.production               # 新增：生产环境变量
├── app/
│   └── layout.tsx                # 修改：引入 BaiduAnalytics
├── components/
│   └── BaiduAnalytics.tsx        # 新增：百度统计组件
└── lib/
    └── analytics.ts              # 新增：统计工具函数
```

---

## 八、参考链接

- [百度统计官网](https://tongji.baidu.com)
- [百度统计 API 文档](https://tongji.baidu.com/analytics-manual/involve/web.html)
- [Next.js App Router 文档](https://nextjs.org/docs/app)

