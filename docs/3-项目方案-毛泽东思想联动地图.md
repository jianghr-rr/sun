## 毛泽东思想履历联动地图（方案稿）

目标：围绕毛泽东的履历与著述，将"时间—地点—文案"联动起来。用户可在三维地图上查看活动区域与范围，并在文案中理解当时背景与思想形成的脉络。

---

### ✅ 已完成（2026-01-15）

**基础框架搭建**
- [x] CesiumJS 集成（3D 地球渲染）
- [x] 天地图底图接入（影像 + 中文注记）
- [x] 首页全屏地图展示，定位到中国
- [x] Turbopack 兼容（脚本拷贝 Cesium 静态资源，无需 webpack）
- [x] 环境变量配置（`NEXT_PUBLIC_TDT_KEY`）

**技术实现细节**
- 依赖：`cesium@1.137.0`、`@emotion/cache`
- 静态资源：`scripts/copy-cesium.js` 自动拷贝到 `public/cesium/`
- 组件：
  - `components/MapViewer.tsx`：Cesium Viewer 封装
  - `components/DynamicMapViewer.tsx`：动态导入，禁用 SSR
  - `components/HomePage.tsx`：全屏地图布局
- 样式：`globals.css` 中 `.cesium-viewer` 绝对定位填满容器

**待完成**
- [ ] 时间轴组件
- [ ] 事件点位 / 路线 / 区域标识
- [ ] Markdown 文案渲染
- [ ] 地图与文案联动
- [ ] 数据结构与示例数据

---

### 核心体验
- 三维地图：展示活动地点、路线、区域范围；支持时间段播放与缩放。
- 文案区（Markdown）：按时间/主题组织文案，带引用与来源。
- 地图—文案联动：点击地图高亮对应文案；点击文案定位地图。

### 功能清单（MVP → 可扩展）
MVP：
- 时间轴：按年份/阶段浏览履历与思想相关事件。
- 事件点/区域：地点点位、路线、多边形范围。
- 文案渲染：Markdown + 引用脚注。
- 联动机制：选中事件 → 地图聚焦 + 文案滚动定位。

可扩展：
- 多层筛选：按主题（军事/政治/理论）、文献类型、人物。
- 搜索：按关键词/地点/事件名搜索。
- 关联链路：某段文案可关联多个事件或地点。
- 多语言版本、引用规范化、导出阅读清单。

### 数据模型（建议）
事件与文案解耦，通过关联字段联动。

- `Event`
  - `id`：唯一标识
  - `title`：事件名称
  - `timeStart` / `timeEnd`
  - `location`：`{ name, lng, lat }`
  - `geometry`：`Point | LineString | Polygon`（GeoJSON）
  - `tags`：主题标签
  - `relatedDocIds`：关联文案 ID
  - `sources`：引用来源

- `Doc`
  - `id` / `title`
  - `markdown`：正文
  - `timeRange`：可选，方便定位
  - `relatedEventIds`：关联事件
  - `references`：脚注/引用

数据形态建议：
- 初期：本地 `data/*.json` + `docs/*.md`（灰度解析）
- 后期：接入 CMS（如 Sanity / Contentlayer / Notion API）

### 技术选型建议
已知基础：`Next.js 16`（App Router）、`React 19`、`Chakra UI`、`Tailwind`

地图/三维：
- 首选：`CesiumJS`（真正 3D 地球、时间轴能力强）
- 备选：`MapLibre GL + deck.gl`（更轻量，需手工构建 3D 场景）
- 地理数据：`GeoJSON` + `TopoJSON`（可做区域范围）

文案渲染：
- `react-markdown` + `remark-gfm` + `rehype-highlight`
- 若需组件化：`MDX`（支持文内嵌组件与自定义标记）

联动与状态：
- 轻量状态：`Zustand` 或 `Jotai`
- URL 同步：用 `searchParams` 保存当前事件/时间范围

图形与时间轴：
- 简单时间轴：自定义组件 + CSS
- 复杂时间轴：`visx` / `d3`（按需引入）

### 地图接入实施方案（Cesium + 国内底图）
目标：在 `Next.js` 项目中集成 Cesium 3D 地球、接入国内底图，并支持时间轴、动态路径、区域标识与文案联动。

#### 1) 依赖与基础准备 ✅
- 安装：`cesium@1.137.0`
- 环境变量：`NEXT_PUBLIC_TDT_KEY`（天地图 key，存于 `.env.local`）
- 静态资源：`scripts/copy-cesium.js` 在 `predev` / `prebuild` 时自动拷贝到 `public/cesium/`
- 样式：组件内引入 `cesium/Build/Cesium/Widgets/widgets.css`，全局 CSS 补充 `.cesium-viewer` 定位样式

#### 2) Cesium Viewer 初始化（前端渲染）✅
- `DynamicMapViewer.tsx`：使用 `next/dynamic` + `ssr: false`，仅客户端渲染
- `MapViewer.tsx`：Viewer 配置
  - 关闭所有默认 UI（`animation`、`timeline`、`geocoder` 等）
  - `baseLayerPicker: false`，`imageryProvider: false`
  - 初始化后 `flyTo` 定位到中国（104°E, 35°N, 8000km 高度）
- Hydration 修复：`providers.tsx` 使用 `@emotion/cache` + 客户端挂载等待

#### 3) 国内底图接入（天地图）✅
- 使用 `WebMapTileServiceImageryProvider` 加载：
  - 影像底图：`img_w`（WMTS）
  - 中文注记：`cia_w`（WMTS）
- 子域名负载均衡：`t0` ~ `t7`
- 天地图 key 通过环境变量注入 URL

#### 4) 时间轴与数据加载
- 统一时间轴：`Clock` + `TimeIntervalCollection`
- 事件点位、路线、范围统一进入 `DataSource`：
  - 点位：`Entity.position`
  - 路线：`PolylineGraphics`
  - 范围：`PolygonGraphics` 或 `GeoJsonDataSource`
- 数据建议分层加载：
  - `base`: 基础事件点
  - `path`: 轨迹/路线
  - `area`: 区域范围

#### 5) 动态路径实现（关键流程）
- 事件路径转为时间序列 `SampledPositionProperty`
- 在 `viewer.clock` 变化时更新实体位置
- 可选：`PathGraphics` 显示历史轨迹

#### 6) 区域标识实现（关键流程）
- 直接加载 GeoJSON（`GeoJsonDataSource.load`）
- 统一样式：边框色、填充透明度、是否贴地
- 区域与事件绑定：`entity.properties.eventId`

#### 7) 文案联动（事件驱动）
- 当文案选中事件：
  - 地图 `flyTo` 对应实体
  - 高亮实体样式（颜色/大小/透明度）
- 当地图选中实体：
  - 更新全局状态（如 `selectedEventId`）
  - 文案自动滚动到对应锚点

#### 8) 性能与加载策略
- 地图组件拆分：首屏只加载文案，地图异步加载
- 数据切片：按时间/区域分片加载
- 资源缓存：常用瓦片与 GeoJSON 做缓存策略

#### 9) 目录结构（当前）
```
apps/sun/
├── .env.local                  # 环境变量（天地图 key）
├── scripts/
│   └── copy-cesium.js          # Cesium 静态资源拷贝脚本
├── public/
│   └── cesium/                 # Cesium 静态资源（自动生成，已 gitignore）
├── components/
│   ├── MapViewer.tsx           # Cesium Viewer 封装
│   ├── DynamicMapViewer.tsx    # 动态导入包装
│   ├── HomePage.tsx            # 首页布局
│   └── ThemeToggle.tsx         # 主题切换
├── app/
│   ├── globals.css             # 全局样式（含 Cesium 样式）
│   ├── providers.tsx           # Chakra + Emotion 配置
│   ├── layout.tsx
│   └── page.tsx
└── data/                       # （待添加）
    ├── events.json
    └── areas.geojson
```

#### 10) 验收清单（最小可用）
- [x] 能看到 3D 地球 + 国内底图
- [ ] 能加载 1 条动态路径并随时间移动
- [ ] 能标识 1 个活动区域（多边形）
- [ ] 地图/文案能互相定位并高亮

### Cesium 动态路径与区域标识（补充）
动态路径（随时间移动）：
- 使用 `SampledPositionProperty` 记录时间序列位置
- 用 `VelocityOrientationProperty` 让模型/图标朝向运动方向
- 配合 `Clock` 与 `TimeIntervalCollection` 控制播放区间
- 需要轨迹线时，配合 `PathGraphics` 展示历史路径

区域标识（活动范围）：
- 使用 `PolygonGraphics` / `RectangleGraphics` / `Polyline` 表达范围
- 支持填充、描边、透明度与高度（可做“范围浮层”）
- 数据直接用 `GeoJSON`，通过 `GeoJsonDataSource` 加载

数据示例（简化）：
```json
{
  "id": "event-1935-01",
  "title": "遵义会议",
  "timeStart": "1935-01-15T00:00:00Z",
  "timeEnd": "1935-01-17T00:00:00Z",
  "path": [
    { "time": "1935-01-14T00:00:00Z", "lng": 106.92, "lat": 27.73 },
    { "time": "1935-01-15T00:00:00Z", "lng": 106.93, "lat": 27.70 }
  ],
  "area": {
    "type": "Polygon",
    "coordinates": [[[106.90,27.72],[106.96,27.72],[106.96,27.68],[106.90,27.68],[106.90,27.72]]]
  }
}
```

### 交互设计要点
- 地图和文案同一“选中事件”状态。
- 文案滚动时自动高亮对应地图点位。
- 时间轴变化触发地图范围与文案列表刷新。

### 实施步骤（建议）
1. 数据梳理：整理履历事件与对应文案的结构与字段。
2. 地图原型：建立 3D 地图，展示点位与路线。
3. Markdown 渲染：搭建文案展示、引用与锚点。
4. 联动逻辑：事件选择 → 地图聚焦 + 文案定位。
5. 体验优化：过滤、搜索、性能、加载策略。

### 风险与注意事项
- 地图 SDK 体积较大，需代码分割与按需加载。
- 历史资料版权与引用规范需提前确认。
- 地理数据精度与历史地名变化可能影响体验。


